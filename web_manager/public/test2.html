<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-database.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.slim.js" integrity="sha256-HwWONEZrpuoh951cQD1ov2HUK5zA5DwJ1DNUXaM6FsY=" crossorigin="anonymous"></script>

  <canvas id="mycanvas"></canvas>

  <script>
    const firebaseConfig = {
      
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    const storage = firebase.storage();

    var storageRef = storage.ref();

    function wrapText(context, text, x, y) {
      var words = text.split(' ');
      var new_words = [];

      for(var n = 0; n < words.length; n++) {
        if (context.measureText(words[n]).width > 100){
          new_words.push(words[n].substr(0, 4));
          new_words.push(words[n].substr(4));
        }
        else{
          new_words.push(words[n]);
        }
      }
      var len = new_words.length;

      if (len > 4){
        context.font = `${15 - len}px Verdana`;
      }

      for(var i = 0; i < len; i++){
        context.fillText(new_words[i], x, y - 10 * (len - 1) + 20 * i);
      }
    }

    var setCanvas = function(Info){
      var canvas = document.getElementById('mycanvas');
      if (canvas.getContext) {
        var ctx = canvas.getContext('2d');

        var imageObj = new Image();
        var pathObj = new Image();

        pathObj.setAttribute("crossOrigin", "anonymous");
        imageObj.setAttribute("crossOrigin", "anonymous");

        imageObj.onload = function () {
          pathObj.onload = function () {
            canvas.width=517;
            canvas.height=1180;

            ctx.drawImage(imageObj, 0, 0, canvas.width, canvas.height);
            ctx.drawImage(pathObj, 0, 0, canvas.width, canvas.height);
          
            $.each(Info.loc, function(key, item){
              ctx.textBaseline = 'middle';
              ctx.textAlign = "center";
              ctx.font="15px Verdana";
              ctx.fillStyle = "white";
              wrapText(ctx, item.Name, item.x, item.y);
              ctx.fill();
            });
    
            canvas.toBlob(function(blob){
              var uploadTask = storageRef.child('result/'+`${Info.index}.png`).put(blob);
            }, 'image/png', 1.0);
    
            ctx.clearRect(0, 0, canvas.width, canvas.height);
          }
          pathObj.src = Info.path_url;
        };
        imageObj.src = Info.url;
      };
    };

    var Setfuction = function(storage_path, floorNum, index){
      const dbref = firebase.database().ref(floorNum);
      var storagePathReference = storage.ref('floor3/3층 기본 지도(명칭x).png');
      var path_ref = storage.ref('path/floor3/'+ `${index}.png`);
      var imageInfo = {};
      imageInfo.loc = [];
      imageInfo.index = index;

      storagePathReference.getDownloadURL().then(url => {
        imageInfo.url = url;
        dbref.on('value', (snapshot) => {
          list = Object.values(snapshot.val());
          for(var i = 0; i < list.length; i++){
            if(list[i]['position_key'] == undefined){continue;};
            imageInfo.loc.push({x: list[i]['position_key']['x'], 
                                y: list[i]['position_key']['y'], 
                                Name: list[i]['name']});
          }
        });
        path_ref.getDownloadURL().then(url => {
          imageInfo.path_url = url;
          setCanvas(imageInfo);
        }).catch(console.log);
      }).catch(console.log);
    }
    
    var list3 = ['301', '303', '305', '307', '309', '311', '314', 
      '316', '318', '320', '321', '322', '323', '324', '326', '327', '329']

    for(var i = 0; i < list3.length; i++){
      Setfuction('path/floor3/', '3', list3[i]);
    }

  </script>
</body>
</html>